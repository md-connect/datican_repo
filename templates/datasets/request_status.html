{% extends 'base.html' %}
{% load static %}
{% block title %}Request Status - {{ data_request.dataset.title }}{% endblock %}

{% block extra_head %}
<style>
  .sticky-search {
    position: sticky;
    top: 0;
    z-index: 40;
    background: white;
    border-bottom: 1px solid #e5e7eb;
  }
  
  @media (max-width: 768px) {
    .sticky-search {
      top: 64px;
      z-index: 30;
    }
    
    .mobile-hide-auth {
      display: none !important;
    }
  }

  /* UPDATED: Custom styles for progress circles - Hollow circle design */
  .progress-circle {
    width: 56px; /* Larger circles */
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .progress-circle-default {
    border: 3px solid #d1d5db; /* Thicker border, no fill */
    background-color: transparent;
  }
  
  .progress-circle-completed {
    border: 3px solid #10b981; /* Green outline, no fill */
    background-color: transparent;
  }
  
  .progress-circle-rejected {
    border: 3px solid #ef4444; /* Red outline, no fill */
    background-color: transparent;
  }
  
  .progress-line {
    height: 3px; /* Thicker line */
    background-color: #d1d5db;
    flex-grow: 1;
    margin: 0 16px;
    position: relative;
    top: 28px; /* Align with center of circles */
  }
  
  .progress-line-completed {
    background-color: #10b981;
  }
  
  .status-label {
    font-size: 0.875rem;
    font-weight: 500;
    margin-top: 12px;
    color: #6b7280;
  }
  
  .status-label-active {
    color: #111827;
    font-weight: 600;
  }

  /* Custom icon styling */
  .progress-icon {
    width: 28px;
    height: 28px;
    stroke-width: 3;
  }
  
  .icon-completed {
    color: #10b981;
  }
  
  .icon-rejected {
    color: #ef4444;
  }
  
  .icon-pending {
    color: #d1d5db;
  }
</style>
{% endblock %}

{% block content %}
<div class="p-4 md:p-6">

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Breadcrumb -->
    <nav class="mb-6 flex items-center text-sm text-gray-600">
      <a href="{% url 'datasets:dataset_list' %}" class="hover:text-primary">Datasets</a>
      <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      <a href="{% url 'datasets:dataset_detail' data_request.dataset.id %}" class="hover:text-primary">{{ data_request.dataset.title|truncatechars:30 }}</a>
      <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      <span class="text-primary font-medium">Request Status</span>
    </nav>

    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-primary mb-2">Request Status</h1>
      <p class="text-gray-600">
        Track the status of your data access request for <span class="font-medium">{{ data_request.dataset.title }}</span>
      </p>
    </div>

    <div class="max-w-4xl mx-auto">
      <!-- Status Card -->
      <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <div class="flex flex-col items-center mb-8">
          {% if data_request.status == 'approved' %}
            <svg class="w-12 h-12 text-green-500 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" fill="none"/>
              <path d="M7 13l3 3 7-7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2 class="text-xl font-semibold text-primary mb-2">Request Approved</h2>
            <p class="text-secondary text-center">Approved on {{ data_request.approved_date|date:"F j, Y" }}</p>
            {% if data_request.director_comment %}
              <p class="text-secondary text-center mt-2 italic">"{{ data_request.director_comment }}"</p>
            {% endif %}
          {% elif data_request.status == 'rejected' %}
            <svg class="w-12 h-12 text-red-500 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" fill="none"/>
              <path d="M15 9l-6 6M9 9l6 6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2 class="text-xl font-semibold text-primary mb-2">Request Rejected</h2>
            {% if data_request.director_comment %}
              <p class="text-secondary text-center italic">"{{ data_request.director_comment }}"</p>
            {% elif data_request.data_manager_comment %}
              <p class="text-secondary text-center italic">"{{ data_request.data_manager_comment }}"</p>
            {% else %}
              <p class="text-secondary text-center">Your request was not approved</p>
            {% endif %}
          {% else %}
            <svg class="w-12 h-12 text-accent mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" fill="none"/>
              <path d="M12 6v6l4 2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2 class="text-xl font-semibold text-primary mb-2">
              {% if data_request.status == 'manager_review' %}
                Under Manager Review
              {% elif data_request.status == 'director_review' %}
                Under Director Review
              {% else %}
                Request Submitted
              {% endif %}
            </h2>
            <p class="text-secondary text-center">
              Submitted on {{ data_request.request_date|date:"F j, Y" }}
            </p>
            <p class="text-gray-500 text-sm text-center mt-2">
              Request ID: {{ data_request.id }}
            </p>
          {% endif %}
        </div>

        <!-- Status Progress Visualization -->
        <div class="relative pt-8 pb-12">
          <div class="flex items-center justify-between mb-2">
            <!-- Submitted Stage -->
            <div class="flex flex-col items-center">
              <div class="progress-circle 
                {% if data_request.status == 'pending' or data_request.status == 'manager_review' or data_request.status == 'director_review' or data_request.status == 'approved' or data_request.status == 'rejected' %}
                  progress-circle-completed
                {% else %}
                  progress-circle-default
                {% endif %}">
                {% if data_request.status == 'pending' or data_request.status == 'manager_review' or data_request.status == 'director_review' or data_request.status == 'approved' or data_request.status == 'rejected' %}
                  <!-- Completed: Hollow green circle with checkmark -->
                  <svg class="progress-icon icon-completed" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none"/>
                    <path d="M7 13l3 3 7-7" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                {% else %}
                  <!-- Pending: Hollow gray circle -->
                  <svg class="progress-icon icon-pending" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none"/>
                  </svg>
                {% endif %}
              </div>
              <div class="status-label {% if data_request.status == 'pending' or data_request.status == 'manager_review' or data_request.status == 'director_review' or data_request.status == 'approved' or data_request.status == 'rejected' %}status-label-active{% endif %}">
                Submitted
              </div>
              <div class="text-xs text-gray-500 mt-1">{{ data_request.request_date|date:"M d, Y" }}</div>
            </div>
            
            <!-- Connecting Line 1 -->
            <div class="progress-line {% if data_request.status == 'manager_review' or data_request.status == 'director_review' or data_request.status == 'approved' or data_request.status == 'rejected' %}progress-line-completed{% endif %}"></div>
            
            <!-- Manager Review Stage -->
            <div class="flex flex-col items-center">
              <div class="progress-circle 
                {% if data_request.status == 'manager_review' or data_request.status == 'director_review' or data_request.status == 'approved' or data_request.status == 'rejected' %}
                  progress-circle-completed
                {% else %}
                  progress-circle-default
                {% endif %}">
                {% if data_request.status == 'manager_review' or data_request.status == 'director_review' or data_request.status == 'approved' or data_request.status == 'rejected' %}
                  <!-- Completed: Hollow green circle with checkmark -->
                  <svg class="progress-icon icon-completed" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none"/>
                    <path d="M7 13l3 3 7-7" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                {% else %}
                  <!-- Pending: Hollow gray circle -->
                  <svg class="progress-icon icon-pending" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none"/>
                  </svg>
                {% endif %}
              </div>
              <div class="status-label {% if data_request.status == 'manager_review' or data_request.status == 'director_review' or data_request.status == 'approved' or data_request.status == 'rejected' %}status-label-active{% endif %}">
                Manager's Review
              </div>
              {% if data_request.manager_review_date %}
                <div class="text-xs text-gray-500 mt-1">{{ data_request.manager_review_date|date:"M d, Y" }}</div>
              {% else %}
                <div class="text-xs text-gray-400 mt-1">Pending</div>
              {% endif %}
            </div>
            
            <!-- Connecting Line 2 -->
            <div class="progress-line {% if data_request.status == 'director_review' or data_request.status == 'approved' or data_request.status == 'rejected' %}progress-line-completed{% endif %}"></div>
            
            <!-- Final Decision Stage -->
            <div class="flex flex-col items-center">
              <div class="progress-circle 
                {% if data_request.status == 'approved' %}
                  progress-circle-completed
                {% elif data_request.status == 'rejected' %}
                  progress-circle-rejected
                {% else %}
                  progress-circle-default
                {% endif %}">
                {% if data_request.status == 'approved' %}
                  <!-- Approved: Hollow green circle with checkmark -->
                  <svg class="progress-icon icon-completed" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none"/>
                    <path d="M7 13l3 3 7-7" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                {% elif data_request.status == 'rejected' %}
                  <!-- Rejected: Hollow red circle with X -->
                  <svg class="progress-icon icon-rejected" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none"/>
                    <path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                {% else %}
                  <!-- Pending: Hollow gray circle -->
                  <svg class="progress-icon icon-pending" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none"/>
                  </svg>
                {% endif %}
              </div>
              <div class="status-label {% if data_request.status == 'approved' or data_request.status == 'rejected' %}status-label-active{% endif %}">
                Final Decision
              </div>
              {% if data_request.approved_date %}
                <div class="text-xs text-gray-500 mt-1">{{ data_request.approved_date|date:"M d, Y" }}</div>
              {% elif data_request.status == 'rejected' %}
                <div class="text-xs text-gray-500 mt-1">Rejected</div>
              {% else %}
                <div class="text-xs text-gray-400 mt-1">Pending</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Request Details -->
        <div class="mt-8 space-y-6">
          <h3 class="text-lg font-semibold text-primary border-b pb-2">Request Details</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="text-sm font-medium text-gray-700 mb-1">Dataset</h4>
              <p class="font-medium">{{ data_request.dataset.title }}</p>
              <a href="{% url 'dataset_detail' data_request.dataset.id %}" class="text-sm text-accent hover:underline mt-1 inline-block">
                View Dataset Details ‚Üí
              </a>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-700 mb-1">Institution</h4>
              <p class="font-medium">{{ data_request.institution }}</p>
            </div>
          </div>
          
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Project Title</h4>
            <p class="font-medium">{{ data_request.project_title }}</p>
          </div>
          
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Project Description</h4>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="whitespace-pre-line text-gray-700">{{ data_request.project_description }}</p>
            </div>
          </div>
          
          {% if data_request.form_submission %}
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Submitted Dataset Request Form</h4>
            <a href="{% url 'datasets:request_document_download' data_request.id 'form' %}" 
              class="text-accent hover:underline flex items-center gap-2 bg-gray-50 p-3 rounded-lg inline-block transition-colors hover:bg-gray-100">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="14 2 14 8 20 8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="13" x2="8" y2="13" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="17" x2="8" y2="17" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="10 9 9 9 8 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Download Submitted Form (PDF) - Link expires in 1 hour</span>
            </a>
          </div>
          {% endif %}

          {% if data_request.ethical_approval_proof %}
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Submitted Ethical Approval Document</h4>
            <a href="{% url 'datasets:request_document_download' data_request.id 'ethics' %}" 
              target="_blank"
              class="text-green-600 hover:underline flex items-center gap-2 bg-green-50 hover:bg-green-100 p-3 rounded-lg inline-block transition-colors">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="14 2 14 8 20 8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="9" y1="15" x2="15" y2="15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="12" x2="12" y2="18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Download Ethical Approval Document (Expires in 1 hour)</span>
            </a>
            <div class="mt-2 text-xs text-gray-600">
              <p class="truncate max-w-xs">
                <span class="font-medium">File:</span> {{ data_request.ethical_approval_proof.name }}
              </p>
              {% if data_request.ethical_approval_no %}
                <p>
                  <span class="font-medium">Approval No:</span> {{ data_request.ethical_approval_no }}
                </p>
              {% endif %}
            </div>
          </div>
          {% elif data_request.ethical_approval_no %}
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-yellow-600 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10" fill="none" stroke-width="2"/>
                <path d="M12 8v4m0 4h.01" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div>
                <h4 class="text-sm font-medium text-yellow-800 mb-1">Ethical Approval Information</h4>
                <p class="text-sm text-yellow-700 mb-1">
                  Approval Number: <span class="font-medium">{{ data_request.ethical_approval_no }}</span>
                </p>
                <p class="text-xs text-yellow-600">
                  Note: Ethical approval proof document was not uploaded with this request.
                </p>
              </div>
            </div>
          </div>
          {% endif %}
          
          <!-- Manager Comments -->
          {% if data_request.data_manager_comment %}
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="text-sm font-medium text-primary mb-2">Manager's Comments</h4>
            <p class="text-gray-700 whitespace-pre-line">{{ data_request.data_manager_comment }}</p>
            {% if data_request.manager_review_date %}
              <p class="text-xs text-gray-500 mt-2">Reviewed on: {{ data_request.manager_review_date|date:"M d, Y H:i" }}</p>
            {% endif %}
          </div>
          {% endif %}
          
          <!-- Director Comments -->
          {% if data_request.director_comment %}
          <div class="bg-green-50 p-4 rounded-lg">
            <h4 class="text-sm font-medium text-primary mb-2">Director's Comments</h4>
            <p class="text-gray-700 whitespace-pre-line">{{ data_request.director_comment }}</p>
            {% if data_request.approved_date %}
              <p class="text-xs text-gray-500 mt-2">Decided on: {{ data_request.approved_date|date:"M d, Y H:i" }}</p>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Download Section (Only for approved requests) -->
{% if data_request.status == 'approved' %}
<div class="bg-white rounded-lg shadow-sm p-8 text-center">
  <div class="mb-6">
    <svg class="w-12 h-12 text-accent mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke-linecap="round" stroke-linejoin="round"/>
      <polyline points="7 10 12 15 17 10" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="12" y1="15" x2="12" y2="3" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <h3 class="text-xl font-semibold text-primary mb-2">Dataset Ready for Download</h3>
    
    {% if data_request.can_download %}
    <div class="mb-4">
      <div class="inline-flex items-center bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-medium mb-3">
        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" fill="none"/>
          <path d="M7 13l3 3 7-7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        {{ remaining_downloads }} download(s) remaining
      </div>
      <p class="text-gray-600 mt-3 mb-4">
        Your request has been approved. You can now download the dataset.
      </p>
      <div class="mb-4">
        <div class="inline-flex items-center bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs">
          <svg class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 8v4l3 3" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="10" fill="none"/>
          </svg>
          Downloads used: {{ download_count }} of {{ max_downloads }}
        </div>
      </div>
    </div>

    <!-- üî• UPDATED: B2 Signed URL Download with File Info -->
    <div class="space-y-4">
      {% if data_request.dataset.dataset_path %}
        <!-- File Info Badge -->
        <div class="flex items-center justify-center gap-2 text-sm text-gray-600 mb-2">
          <span class="bg-gray-100 px-3 py-1 rounded-full">
            üìÅ {{ data_request.dataset.dataset_path|cut:"datasets/" }}
          </span>
          {% if data_request.dataset.b2_file_size %}
          <span class="bg-gray-100 px-3 py-1 rounded-full">
            üíæ {{ data_request.dataset.get_file_size_display }}
          </span>
          {% endif %}
        </div>

        <!-- Primary Download Button - Direct B2 Signed URL -->
        <a href="#"
          onclick="window.downloadDataset(event, {{ data_request.dataset.id }}, {{ data_request.id }})"
          class="bg-green-600 text-white px-8 py-4 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center gap-3 mx-auto text-lg w-full md:w-auto min-w-[300px] shadow-sm hover:shadow-md">
          <i data-lucide="download" class="w-6 h-6"></i>
          <span>Download Dataset</span>
          {% if data_request.dataset.b2_file_size and data_request.dataset.b2_file_size > 500000000 %}
          <span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full ml-2">Large File</span>
          {% else %}
          <span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full ml-2">Secure</span>
          {% endif %}
        </a>
        
        <!-- Expiration Notice -->
        <div class="flex items-center justify-center gap-2 text-xs text-gray-500">
          <i data-lucide="clock" class="w-3 h-3"></i>
          <span>Download link expires in 1 hour</span>
          <span class="mx-2">‚Ä¢</span>
          <i data-lucide="shield" class="w-3 h-3"></i>
          <span>Secure B2 Cloud Storage</span>
          <span class="mx-2">‚Ä¢</span>
          <i data-lucide="zap" class="w-3 h-3"></i>
          <span>Direct download</span>
        </div>
        
        <!-- AJAX Download Option (Alternative with progress) -->
        <div class="relative">
          <button onclick="downloadWithProgress({{ data_request.dataset.id }}, {{ data_request.id }})" 
                  class="text-sm text-gray-600 hover:text-primary flex items-center justify-center gap-2 mx-auto mt-2 px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
            <i data-lucide="cloud" class="w-4 h-4"></i>
            <span>Download with progress tracking</span>
          </button>
          
          <!-- Progress bar container (hidden by default) -->
          <div id="download-progress-{{ data_request.dataset.id }}" class="hidden mt-4">
            <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
              <span>Downloading...</span>
              <span id="progress-percent-{{ data_request.dataset.id }}">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div id="progress-bar-{{ data_request.dataset.id }}" 
                   class="bg-green-600 h-2.5 rounded-full transition-all duration-300" 
                   style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-500 mt-1">
              <span id="downloaded-{{ data_request.dataset.id }}">0 MB</span>
              <span id="total-size-{{ data_request.dataset.id }}">
                {% if data_request.dataset.b2_file_size %}
                  {{ data_request.dataset.get_file_size_display }}
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      {% else %}
        <!-- No file available -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
          <p class="text-yellow-800">
            ‚ö†Ô∏è This dataset file is not available. Please contact support.
          </p>
        </div>
      {% endif %}
    </div>

    {% else %}
    <!-- Download Limit Reached -->
    <div class="mb-4">
      <div class="inline-flex items-center bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full text-sm font-medium mb-3">
        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" fill="none"/>
          <path d="M12 8v4m0 4h.01" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Download Limit Reached
      </div>
      <p class="text-gray-600 mt-3 mb-4">
        You have reached your download limit for this dataset.
      </p>
      <div class="mb-4">
        <div class="inline-flex items-center bg-red-50 text-red-700 px-3 py-1 rounded-full text-xs">
          <svg class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Downloads used: {{ download_count }} of {{ max_downloads }}
        </div>
      </div>
    </div>
    
    <!-- Request Access Again -->
    {% if can_request_again %}
    <div class="mb-6">
      <p class="text-gray-600 mb-4">
        You can submit a new request to get more downloads.
      </p>
      <a href="{% url 'dataset_request' data_request.dataset.id %}" 
         class="bg-accent text-white px-6 py-3 rounded-lg hover:bg-accent/90 transition-colors font-medium flex items-center justify-center gap-2 mx-auto">
        <i data-lucide="file-text" class="w-5 h-5"></i>
        Request Access Again
      </a>
    </div>
    {% else %}
    <button disabled class="bg-gray-200 text-gray-500 px-8 py-4 rounded-lg cursor-not-allowed flex items-center justify-center gap-3 mx-auto text-lg">
      <i data-lucide="download" class="w-6 h-6"></i>
      Download Limit Reached
    </button>
    {% endif %}
    {% endif %}
    
    <!-- Download History -->
    {% if download_history %}
    <div class="mt-8 pt-6 border-t border-gray-200">
      <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
        <i data-lucide="history" class="w-4 h-4 mr-2"></i>
        Download History
      </h4>
      <div class="space-y-2">
        {% for download in download_history %}
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Download #{{ download.count }}</span>
          {% if download.date %}
          <span class="text-gray-500">{{ download.date|date:"M d, Y H:i" }}</span>
          {% else %}
          <span class="text-gray-400">Date not recorded</span>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    
    <!-- Support Contact -->
    <div class="mt-6 pt-6 border-t border-gray-200">
      <p class="text-sm text-gray-500 flex items-center justify-center gap-2">
        <i data-lucide="help-circle" class="w-4 h-4"></i>
        Need more downloads? 
        <a href="mailto:{{ settings.SUPPORT_EMAIL }}" class="text-accent hover:underline font-medium ml-1">
          Contact support
        </a>
      </p>
    </div>
  </div>
</div>
{% endif %}

      <!-- For rejected requests, show option to submit new request -->
      {% if data_request.status == 'rejected' and can_request_again %}
      <div class="bg-white rounded-lg shadow-sm p-8 text-center mt-8">
        <div class="mb-6">
          <svg class="w-12 h-12 text-red-500 mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" fill="none"/>
            <path d="M15 9l-6 6M9 9l6 6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <h3 class="text-xl font-semibold text-primary mb-2">Request Rejected</h3>
          <p class="text-gray-600 mb-4">
            Your request was not approved. You can submit a new request with updated information.
          </p>
          <a href="{% url 'dataset_request' data_request.dataset.id %}" 
            class="bg-accent text-white px-8 py-4 rounded-lg hover:bg-accent/90 transition-colors font-medium flex items-center justify-center gap-3 mx-auto text-lg">
            <i data-lucide="file-text" class="w-6 h-6"></i>
            Submit New Request
          </a>
        </div>
      </div>
      {% endif %}

<!-- Navigation Links (Updated) -->
<div class="mt-8 flex flex-col sm:flex-row gap-4">
  <a href="{% url 'dataset_detail' data_request.dataset.id %}" 
     class="flex-1 text-center border border-primary text-primary px-6 py-3 rounded-lg hover:bg-blue-50 transition-colors">
    ‚Üê Back to Dataset
  </a>
  {% if can_request_again %}
  <a href="{% url 'dataset_request' data_request.dataset.id %}" 
     class="flex-1 text-center bg-accent text-white px-6 py-3 rounded-lg hover:bg-accent/90 transition-colors">
    Request Access Again
  </a>
  {% else %}
  <a href="{% url 'dataset_list' %}" 
     class="flex-1 text-center bg-gray-100 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-200 transition-colors">
    Browse More Datasets
  </a>
  {% endif %}
</div>
    </div>
  </div>
</div>
{% endblock %}


{% block extra_scripts %}
<script>
// ==================== UTILITY FUNCTIONS ====================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ==================== DOWNLOAD TRACKING ====================
function trackDownload(requestId) {
    const csrftoken = getCookie('csrftoken');
    
    // Use fetch with keepalive to ensure request completes
    fetch(`/api/record-download/${requestId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        keepalive: true, // Critical for page navigation
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.ok) {
            console.log('Download recorded successfully');
        }
    })
    .catch(error => console.error('Error recording download:', error));
}

// ==================== PROGRESS UPDATE ====================
function updateProgress(datasetId, percent) {
    const progressBar = document.getElementById(`progress-bar-${datasetId}`);
    const progressPercent = document.getElementById(`progress-percent-${datasetId}`);
    const downloadedSpan = document.getElementById(`downloaded-${datasetId}`);
    
    if (progressBar) {
        progressBar.style.width = percent + '%';
    }
    if (progressPercent) {
        progressPercent.textContent = Math.round(percent) + '%';
    }
    if (downloadedSpan && percent < 100) {
        downloadedSpan.textContent = Math.round(percent) + '%';
    } else if (downloadedSpan && percent >= 100) {
        downloadedSpan.textContent = 'Complete';
    }
}

// ==================== SIMULATE PROGRESS (For visual feedback) ====================
function simulateProgress(datasetId) {
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
        }
        updateProgress(datasetId, progress);
    }, 300);
    return interval; // Return interval so it can be cleared if needed
}

// ==================== PRIMARY DOWNLOAD FUNCTION ====================
window.downloadDataset = function(event, datasetId, requestId = null) {
    // Prevent default if called from button
    if (event) {
        event.preventDefault();
    }
    
    const button = event?.currentTarget;
    const originalHtml = button ? button.innerHTML : '';
    const progressContainer = document.getElementById(`download-progress-${datasetId}`);
    let progressInterval = null;
    
    // Show loading state if button exists
    if (button) {
        button.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Generating secure link...';
        button.disabled = true;
        lucide.createIcons();
    }
    
    // Show progress container if it exists
    if (progressContainer) {
        progressContainer.classList.remove('hidden');
        updateProgress(datasetId, 10); // Start at 10% to show activity
        // Start simulated progress
        progressInterval = simulateProgress(datasetId);
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/datasets/api/dataset/${datasetId}/download-url/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.url) {
            // Clear progress interval
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            // Update progress to 50% - link generated
            updateProgress(datasetId, 50);
            
            // Trigger download
            window.location.href = data.url;
            
            // Track the download if requestId provided
            if (requestId) {
                trackDownload(requestId);
            }
            
            // Update progress to 100% - download started
            updateProgress(datasetId, 100);
            
            // Show success message on button
            if (button) {
                button.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Download started!';
                button.classList.remove('hover:bg-gray-50');
                button.classList.add('text-green-600', 'border-green-600');
            }
            
            // Hide progress after 2 seconds
            setTimeout(() => {
                if (progressContainer) {
                    progressContainer.classList.add('hidden');
                }
                // Reload to update download count if this is a tracked request
                if (requestId) {
                    location.reload();
                }
            }, 2000);
        } else {
            throw new Error(data.error || 'Failed to generate download link');
        }
    })
    .catch(error => {
        console.error('Download error:', error);
        alert('Download failed: ' + error.message);
        
        // Clear progress interval
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        
        // Reset button
        if (button) {
            button.innerHTML = originalHtml;
            button.disabled = false;
        }
        
        // Hide progress
        if (progressContainer) {
            progressContainer.classList.add('hidden');
        }
    })
    .finally(() => {
        lucide.createIcons();
    });
};

// ==================== LEGACY SUPPORT (if needed) ====================
// Keep this for backward compatibility with your existing buttons
window.downloadWithProgress = function(datasetId, requestId) {
    window.downloadDataset(null, datasetId, requestId);
};

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }
    
    // Attach click handlers to any download buttons with data attributes
    document.querySelectorAll('[data-download-dataset]').forEach(button => {
        const datasetId = button.dataset.downloadDataset;
        const requestId = button.dataset.downloadRequest;
        button.addEventListener('click', (e) => window.downloadDataset(e, datasetId, requestId));
    });
});
</script>
{% endblock %}
