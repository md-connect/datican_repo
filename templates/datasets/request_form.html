{% extends 'base.html' %} 
{% load static %} 
{% block title %}Request Access - {{ dataset.title }}{% endblock %} 

{% block extra_head %}
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  .sticky-search {
    position: sticky;
    top: 0;
    z-index: 40;
    background: white;
    border-bottom: 1px solid #e5e7eb;
  }
  
  @media (max-width: 768px) {
    .sticky-search {
      top: 64px;
      z-index: 30;
    }
    
    .mobile-hide-auth {
      display: none !important;
    }
  }
  
  /* Custom styles */
  .form-section {
    display: none;
  }
  
  .form-section.active {
    display: block;
  }
  
  .step-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 2rem;
  }
  
  .step {
    display: flex;
    align-items: center;
    font-weight: 500;
    color: #6b7280;
  }
  
  .step.active {
    color: #dc2626;
  }
  
  .step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #f3f4f6;
    border: 2px solid #e5e7eb;
    margin-right: 8px;
    font-weight: 600;
  }
  
  .step.active .step-number {
    background-color: #dc2626;
    border-color: #dc2626;
    color: white;
  }
  
  .step-divider {
    width: 60px;
    height: 2px;
    background-color: #e5e7eb;
    margin: 0 12px;
  }
  
  .upload-area {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .upload-area:hover {
    border-color: #dc2626;
    background-color: #fef2f2;
  }
  /* Add to your existing CSS */
.upload-area {
  min-height: 180px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.upload-area:hover {
  border-color: #dc2626;
  background-color: #fef2f2;
}

#formFileDisplay, #ethicalFileDisplay {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
{% endblock %} 

{% block content %}
<div class="p-4 md:p-6">

<!-- Desktop Sticky Header -->
<div class="hidden md:block sticky-dataset-header">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
    <div class="flex items-center justify-between">
      <!-- Breadcrumb -->
      <nav class="mb-6 flex items-center text-sm text-gray-600">
        <a href="{% url 'dataset_list' %}" class="hover:text-primary">Datasets</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="{% url 'dataset_detail' dataset.id %}" class="hover:text-primary">{{ dataset.title|truncatechars:30 }}</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-primary font-medium">Request Access</span>
      </nav>
      
      <!-- Authentication Circle - FIXED: Always circular -->
              <div class="flex items-center space-x-4 ml-4">
          {% if user.is_authenticated %}
            <div class="relative" x-data="{ profileOpen: false }">
              <button 
                type="button"
                class="focus:outline-none"
                @click="profileOpen = !profileOpen"
                @mouseenter="profileOpen = true"
                @mouseleave="setTimeout(() => { if (!profileOpen) profileOpen = false }, 100)"
              >
                {% if user.profile.avatar %}
                  <img
                    src="{{ user.profile.avatar.url }}"
                    class="auth-circle h-10 w-10 cursor-pointer border-2 border-transparent hover:border-primary rounded-full"
                    alt="Profile"
                  />
                {% else %}
                  <!-- User icon SVG -->
                  <div class="user-icon h-10 w-10 cursor-pointer hover:opacity-90 text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-full h-full">
                      <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd" />
                    </svg>
                  </div>
                {% endif %}
              </button>
              
              <!-- Profile Dropdown - DEBUGGED VERSION -->
              <div
                x-show="profileOpen"
                x-cloak
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 transform scale-95"
                x-transition:enter-end="opacity-100 transform scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 transform scale-100"
                x-transition:leave-end="opacity-0 transform scale-95"
                class="absolute right-0 mt-2 min-w-[220px] bg-white shadow-xl rounded-lg py-3 z-50 border border-gray-200"
                style="display: none;"
                @mouseenter="profileOpen = true"
                @mouseleave="profileOpen = false"
                @click.away="profileOpen = false"
              >
                <a href="{% url 'profile' %}" class="block px-5 py-3 text-gray-800 hover:bg-gray-50 transition-colors border-b border-gray-100">
                  <div class="flex items-center">
                    <svg class="w-5 h-5 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="font-small">My Profile</span>
                  </div>
                </a>
                
                <a href="{% url 'account_change_password' %}" class="block px-5 py-3 text-gray-800 hover:bg-gray-50 transition-colors border-b border-gray-100">
                  <div class="flex items-center">
                    <svg class="w-5 h-5 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                    <span class="font-small">Change Password</span>
                  </div>
                </a>
                
                <form action="{% url 'account_logout' %}" method="POST" class="block">
                  {% csrf_token %}
                  <button type="submit" class="w-full text-left px-5 py-3 text-gray-800 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center">
                      <svg class="w-5 h-5 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                      </svg>
                      <span class="font-small">Logout</span>
                    </div>
                  </button>
                </form>
              </div>
            </div>
          {% else %}
            <div class="flex items-center space-x-3">
              <a href="{% url 'login' %}" class="text-dark hover:text-accent font-medium transition-colors">Sign In</a>
              <a href="{% url 'signup' %}" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-red-600 font-medium transition-colors">Register</a>
            </div>
          {% endif %}
        </div>
    </div>
  </div>
</div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 mt-16 sm:mt-0">     
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-xl md:text-3xl font-bold text-primary mb-2 break-words">Request Access: {{ dataset.title }}</h1>
      <p class="text-gray-600">
        Complete the two-step process to request access to this dataset.
      </p>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step active" id="step1">
        <div class="step-number">1</div>
        <span>Application Guidelines</span>
      </div>
      <div class="step-divider"></div>
      <div class="step" id="step2">
        <div class="step-number">2</div>
        <span>Application Form</span>
      </div>
    </div>

    <!-- Guidelines Section (Step 1) -->
    <div id="guidelinesSection" class="form-section active">
      <div class="max-w-5xl mx-auto">
        <!-- Information Section -->
        <div class="bg-secondary/10 rounded-lg p-6 mb-8 border border-secondary/20">
          <h2 class="text-xl font-semibold text-primary mb-4 flex items-center gap-2">
            <i data-lucide="info" class="w-6 h-6 text-accent"></i>
            Application Guidelines
          </h2>
          <div class="space-y-3 text-sm text-secondary">
            <p class="text-primary font-medium">Required information:</p>
            <ul class="list-disc list-inside space-y-2 pl-4">
              <li>Valid institution email address</li>
              <li>Phone number for verification</li>
              <li>Ethical approval number</li>
              <li>Project title and description</li>
            </ul>
            
            <p class="text-primary font-medium mt-4">Required documents:</p>
            <ul class="list-disc list-inside space-y-2 pl-4">
              <li>Completed request form (download template below) <span class="text-red-500">*</span></li>
              <li>Proof of ethical approval</li>
            </ul>
            
            <div class="pt-4 border-t border-secondary/20">
              <p class="text-primary font-medium mt-2">Submission steps:</p>
              <ol class="list-decimal list-inside space-y-2 pl-4">
                <li>Download and complete the Data Request Form</li>
                <li>Have the form signed by your Project Supervisor</li>
                <li>Gather ethical approval documentation</li>
                <li>Scan all documents as PDF/JPG/PNG</li>
                <li>Fill in all required information</li>
                <li>Upload documents Data Request Form and Ethical Approval Documents using the form below</li>
              </ol>
            </div>

            <div class="mt-4">
              <a href="{% static 'datasets/DATICAN_Dataset_Request_Form.docx' %}" 
                 class="text-accent hover:text-accent/80 font-medium flex items-center gap-2" 
                 download="DATICAN_Dataset_Request_Form.docx">
                <i data-lucide="download" class="w-5 h-5"></i>
                <span>Download Request Form (DOCX)</span>
              </a>
              <span class="text-gray-500 text-sm ml-7">(Last updated: {% now "Y-m-d" %})</span>
            </div>

            <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
              <div class="flex items-start gap-2">
                <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-500 mt-0.5"></i>
                <div class="text-sm">
                  <p class="text-black font-medium">Important Notes:</p>
                  <ul class="list-disc list-inside ml-2 text-black-700">
                    <li>All fields marked with * are required</li>
                    <li>Request form must be in PDF format (max 25MB)</li>
                    <li>Ethical approval proof can be PDF, JPG, or PNG</li>
                    <li>Applications typically processed within 7 business days</li>
                    <li>Upon approval, you will be notified via your registered email, and then you can proceed to download the dataset.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Proceed Button -->
        <div class="text-center">
          <button id="proceedToForm" class="bg-accent text-white px-8 py-3 rounded-lg hover:bg-accent/90 transition-colors font-medium flex items-center gap-2 mx-auto">
            <i data-lucide="arrow-right" class="w-5 h-5"></i>
            Proceed to Application Form
          </button>
          <a href="{% url 'dataset_detail' dataset.id %}" class="mt-4 inline-block text-gray-600 hover:text-primary">
            ← Back to Dataset
          </a>
        </div>
      </div>
    </div>

    <!-- Form Section (Step 2) -->
<div id="formSection" class="form-section">
  <div class="max-w-5xl mx-auto">
    <!-- Back Button -->
    <button id="backToGuidelines" class="mb-6 text-accent hover:text-accent/80 font-medium flex items-center gap-2">
      <i data-lucide="arrow-left" class="w-5 h-5"></i>
      Back to Guidelines
    </button>

    <!-- Form Card -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
      <h2 class="text-xl font-semibold text-primary mb-6">Dataset Access Request Form</h2>
      
      <!-- Display messages -->
      {% if messages %}
      <div class="mb-6">
        {% for message in messages %}
        <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}
      
      <form method="post" enctype="multipart/form-data" class="space-y-6" id="requestForm">
        {% csrf_token %}
        
        <!-- Display form errors -->
        {% if form.errors %}
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
          <h4 class="font-medium mb-1">Please correct the following errors:</h4>
          <ul class="list-disc list-inside text-sm">
            {% for field, errors in form.errors.items %}
              {% if field != '__all__' and field != 'warnings' %}
                {% for error in errors %}
                  <li>{{ field|title }}: {{ error }}</li>
                {% endfor %}
              {% endif %}
            {% endfor %}
            {% if form.errors.warnings %}
              <div class="mt-3 bg-yellow-50 border border-yellow-200 text-yellow-700 p-3 rounded">
                <h5 class="font-medium mb-1">Suggestions:</h5>
                <ul class="list-disc list-inside">
                  {% for warning in form.errors.warnings %}
                    <li>{{ warning }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </ul>
        </div>
        {% endif %}
        
        <!-- Researcher Information -->
        <div>
          <label class="block text-sm font-medium text-primary mb-2">Researcher Information</label>
          <div class="grid gap-4 md:grid-cols-2">
            <!-- Read-only user info -->
            <div>
              <label class="block text-sm font-medium text-primary mb-1">First Name</label>
              <input type="text" value="{{ user.first_name }}" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
            </div>
            <div>
              <label class="block text-sm font-medium text-primary mb-1">Last Name</label>
              <input type="text" value="{{ user.last_name }}" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
            </div>
            <div>
              <label class="block text-sm font-medium text-primary mb-1">Email</label>
              <input type="email" value="{{ user.email }}" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
            </div>
            
            <!-- Institution Field -->
            <div>
              <label for="institution" class="block text-sm font-medium text-primary mb-1">
                Institution <span class="text-red-500">*</span>
              </label>
              <input type="text" 
                     name="institution" 
                     id="institution" 
                     value="{{ form.institution.value|default:'' }}"
                     required
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                     placeholder="Your institution/university name">
              <p class="text-xs text-gray-500 mt-1">Name of your institution or university</p>
            </div>
            
            <!-- Phone Number Field -->
            <div>
              <label for="phone_number" class="block text-sm font-medium text-primary mb-1">
                Phone Number
              </label>
              <input type="tel" 
                     name="phone_number" 
                     id="phone_number"
                     value="{{ form.phone_number.value|default:'' }}"
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                     placeholder="+2348030000000 or 0123456789">
            </div>
            
            <!-- Ethical Approval Number Field -->
            <div>
              <label for="ethical_approval_no" class="block text-sm font-medium text-primary mb-1">
                Ethical Approval Number
              </label>
              <input type="text" 
                     name="ethical_approval_no" 
                     id="ethical_approval_no"
                     value="{{ form.ethical_approval_no.value|default:'' }}"
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent">
            </div>
          </div>
        </div>

        <!-- Project Information -->
        <div>
          <label for="project_title" class="block text-sm font-medium text-primary mb-2">
            Project Title <span class="text-red-500">*</span>
          </label>
          <input type="text" 
                 name="project_title" 
                 id="project_title"
                 value="{{ form.project_title.value|default:'' }}"
                 required
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                 placeholder="Enter your project title">
          <p class="text-xs text-gray-500 mt-1">Title of your research project</p>
        </div>

        <div>
          <label for="project_description" class="block text-sm font-medium text-primary mb-2">
            Project Description (Max. 100 words) <span class="text-red-500">*</span>
          </label>
          <textarea name="project_description" 
                    id="project_description"
                    rows="4"
                    maxlength="500"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                    placeholder="A short description of your project (Max. 100 words)">{{ form.project_description.value|default:'' }}</textarea>
          <p class="text-xs text-gray-500 mt-1">Maximum 100 words (about 500 characters)</p>
        </div>

        <!-- File Uploads -->
<div class="grid gap-6 md:grid-cols-2">
  <!-- Completed Form Upload -->
  <div>
    <label class="block text-sm font-medium text-primary mb-2">
      Completed Request Form (PDF) <span class="text-red-500">*</span>
    </label>
    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center h-full upload-area relative" 
         onclick="document.getElementById('form_submission').click()">
      <input type="file" 
             name="form_submission" 
             id="form_submission" 
             accept=".pdf"
             required
             class="hidden"
             onchange="updateFormFileName(this)">
      <div id="formUploadContent" class="flex flex-col items-center text-secondary">
        <i data-lucide="file-text" class="w-8 h-8 mb-2 text-accent"></i>
        <span class="text-accent font-medium">Click to Upload Request Form</span>
        <span class="text-sm">PDF format only</span>
        <span class="text-xs text-gray-500">(Max: 25MB)</span>
      </div>
      <div id="formFilePreview" class="hidden mt-3">
        <div id="formFileDisplay" class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
          <div class="flex items-center space-x-3">
            <i data-lucide="file-text" class="w-6 h-6 text-accent"></i>
            <div>
              <p id="formFileName" class="text-sm font-medium text-primary"></p>
              <p id="formFileSize" class="text-xs text-gray-500"></p>
            </div>
          </div>
          <button type="button" onclick="removeFormFile(event)" class="text-red-500 hover:text-red-700">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>
    <p class="text-xs text-gray-500 mt-1">Required - Upload the completed request form in PDF format (max 25MB)</p>
  </div>

  <!-- Ethical Approval Proof Upload -->
  <div>
    <label class="block text-sm font-medium text-primary mb-2">
      Proof of Ethical Approval
    </label>
    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center h-full upload-area relative"
         onclick="document.getElementById('ethical_approval_proof').click()">
      <input type="file" 
             name="ethical_approval_proof" 
             id="ethical_approval_proof" 
             accept=".pdf,.jpg,.jpeg,.png"
             class="hidden"
             onchange="updateEthicalFileName(this)">
      <div id="ethicalUploadContent" class="flex flex-col items-center text-secondary">
        <i data-lucide="shield-check" class="w-8 h-8 mb-2 text-green-500"></i>
        <span class="text-green-600 font-medium">Click to Upload Ethical Approval</span>
        <span class="text-sm">PDF, JPG, PNG</span>
        <span class="text-xs text-gray-500">(Max: 25MB)</span>
        <span class="text-xs text-gray-500 italic mt-2">Optional but recommended</span>
      </div>
      <div id="ethicalFilePreview" class="hidden mt-3">
        <div id="ethicalFileDisplay" class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
          <div class="flex items-center space-x-3">
            <i data-lucide="file" class="w-6 h-6 text-green-500"></i>
            <div>
              <p id="ethicalFileName" class="text-sm font-medium text-primary"></p>
              <p id="ethicalFileSize" class="text-xs text-gray-500"></p>
            </div>
          </div>
          <button type="button" onclick="removeEthicalFile(event)" class="text-red-500 hover:text-red-700">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>
    <p class="text-xs text-gray-500 mt-1">Upload proof of ethical approval (PDF, JPG, PNG, max 25MB)</p>
  </div>
</div>

        <!-- Submit Button -->
        <div class="pt-4 border-t border-gray-200">
          <button type="submit" class="w-full bg-accent text-white py-3 rounded-lg hover:bg-accent/90 transition-colors font-medium flex items-center justify-center gap-2">
            <i data-lucide="send" class="w-5 h-5"></i>
            Submit Request
          </button>
          <a href="{% url 'dataset_detail' dataset.id %}" class="mt-3 block text-center text-gray-600 hover:text-primary">
            ← Back to Dataset
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
  </div>
</div>

<script>
// This script runs AFTER all HTML is loaded
console.log('Page loaded, setting up event listeners...');

// Set up Proceed button
const proceedBtn = document.getElementById('proceedToForm');
if (proceedBtn) {
  console.log('Found proceed button:', proceedBtn);
  proceedBtn.addEventListener('click', function(e) {
    e.preventDefault();
    console.log('Proceed button clicked!');
    
    // Toggle sections
    document.getElementById('guidelinesSection').classList.remove('active');
    document.getElementById('formSection').classList.add('active');
    
    // Toggle steps
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step2').classList.add('active');
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
} else {
  console.error('Could not find proceed button!');
}

// Set up Back button
const backBtn = document.getElementById('backToGuidelines');
if (backBtn) {
  backBtn.addEventListener('click', function(e) {
    e.preventDefault();
    console.log('Back button clicked');
    
    // Toggle sections
    document.getElementById('formSection').classList.remove('active');
    document.getElementById('guidelinesSection').classList.add('active');
    
    // Toggle steps
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step1').classList.add('active');
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
}

// Initialize Lucide icons
if (typeof lucide !== 'undefined') {
  lucide.createIcons();
}

// File upload display functions
function updateFormFileName(input) {
  const uploadContent = document.getElementById('formUploadContent');
  const filePreview = document.getElementById('formFilePreview');
  const fileName = document.getElementById('formFileName');
  const fileSize = document.getElementById('formFileSize');
  
  if (input.files.length > 0) {
    const file = input.files[0];
    
    // Hide upload prompt, show file preview
    uploadContent.style.display = 'none';
    filePreview.classList.remove('hidden');
    
    // Display file info
    fileName.textContent = file.name;
    fileSize.textContent = formatBytes(file.size);
    
    // Show PDF preview if available
    if (file.type === 'application/pdf') {
      showPdfPreview(file, 'formFilePreview');
    }
  }
}

function updateEthicalFileName(input) {
  const uploadContent = document.getElementById('ethicalUploadContent');
  const filePreview = document.getElementById('ethicalFilePreview');
  const fileName = document.getElementById('ethicalFileName');
  const fileSize = document.getElementById('ethicalFileSize');
  
  if (input.files.length > 0) {
    const file = input.files[0];
    
    // Hide upload prompt, show file preview
    uploadContent.style.display = 'none';
    filePreview.classList.remove('hidden');
    
    // Display file info
    fileName.textContent = file.name;
    fileSize.textContent = formatBytes(file.size);
    
    // Show image preview if it's an image
    if (file.type.startsWith('image/')) {
      showImagePreview(file, 'ethicalFilePreview');
    }
  }
}

// Remove file functions
function removeFormFile(event) {
  event.stopPropagation();
  
  const input = document.getElementById('form_submission');
  const uploadContent = document.getElementById('formUploadContent');
  const filePreview = document.getElementById('formFilePreview');
  
  // Reset file input
  input.value = '';
  
  // Show upload prompt, hide file preview
  uploadContent.style.display = 'flex';
  filePreview.classList.add('hidden');
}

function removeEthicalFile(event) {
  event.stopPropagation();
  
  const input = document.getElementById('ethical_approval_proof');
  const uploadContent = document.getElementById('ethicalUploadContent');
  const filePreview = document.getElementById('ethicalFilePreview');
  
  // Reset file input
  input.value = '';
  
  // Show upload prompt, hide file preview
  uploadContent.style.display = 'flex';
  filePreview.classList.add('hidden');
}

// Show PDF preview
function showPdfPreview(file, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  // Create iframe for PDF preview
  const existingIframe = container.querySelector('iframe');
  if (existingIframe) existingIframe.remove();
  
  const fileURL = URL.createObjectURL(file);
  const iframe = document.createElement('iframe');
  iframe.src = fileURL;
  iframe.className = 'w-full h-48 mt-3 rounded-lg border border-gray-200';
  iframe.title = 'PDF Preview';
  container.appendChild(iframe);
}

// Show image preview
function showImagePreview(file, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  // Create img for image preview
  const existingImg = container.querySelector('img');
  if (existingImg) existingImg.remove();
  
  const fileURL = URL.createObjectURL(file);
  const img = document.createElement('img');
  img.src = fileURL;
  img.className = 'w-full h-48 object-contain mt-3 rounded-lg border border-gray-200';
  img.alt = 'Image Preview';
  container.appendChild(img);
}

// Format file size
function formatBytes(bytes, decimals = 2) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const dm = decimals < 0 ? 0 : decimals;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}
</script>
{% endblock %}