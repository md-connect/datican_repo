{% extends 'base.html' %} 
{% load static %} 
{% block title %}{{ dataset.title }} - Datican{% endblock %} 

{% block extra_head %}
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  /* Fix for mobile navbar toggle button */
  .mobile-sticky-header {
    z-index: 40 !important; /* Higher than sidebar */
  }
  
  /* Fix for desktop sidebar icon visibility */
  aside svg {
    display: block !important;
  }
  
  /* Ensure collapsed sidebar shows icons */
  .collapsed-sidebar .nav-icon {
    display: block !important;
    margin: 0 auto;
  }
  
  /* Remove sticky download button styles */
  .mobile-sticky-download {
    position: relative !important;
    bottom: auto !important;
    right: auto !important;
    left: auto !important;
    z-index: auto !important;
    box-shadow: none !important;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }
  
  /* Make sure metadata preview loads immediately */
  #dataPreview.loaded {
    display: block;
  }
  
  /* ========== PREVIEW SECTION STYLES ========== */
  
  /* Tab styling */
  .preview-tab {
    transition: all 0.2s ease;
    border-bottom-width: 2px;
    border-bottom-color: transparent;
  }
  
  .preview-tab:hover {
    background-color: rgba(243, 244, 246, 0.5);
  }
  
  .preview-tab.border-primary {
    background-color: rgba(59, 130, 246, 0.05);
  }
  
  /* Image preview styles */
  #imageViewer {
    min-height: 300px;
    background: linear-gradient(135deg, #f9fafb 25%, #f3f4f6 25%, #f3f4f6 50%, #f9fafb 50%, #f9fafb 75%, #f3f4f6 75%, #f3f4f6);
    background-size: 20px 20px;
  }
  
  .lazy-load {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .lazy-load.lazy-loaded {
    opacity: 1;
  }
  
  /* Thumbnail gallery */
  .thumbnail-gallery img {
    transition: all 0.2s ease;
  }
  
  .thumbnail-gallery img:hover {
    transform: scale(1.02);
    border-color: #93c5fd !important;
  }
  
  .thumbnail-active {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  /* Metadata table styles */
  #tableContainer {
    scroll-behavior: smooth;
  }
  
  #tableContainer::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  #tableContainer::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  #tableContainer::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  #tableContainer::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
  }
  
  /* Table sticky headers */
  table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    backdrop-filter: blur(8px);
    background-color: rgba(249, 250, 251, 0.95);
  }
  
  table thead th:first-child,
  table tbody td:first-child {
    position: sticky;
    left: 0;
    z-index: 5;
    background-color: inherit;
  }
  
  /* Tooltip for truncated content */
  .group:hover .group-hover\:block {
    animation: fadeIn 0.2s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* ========== README PREVIEW STYLES ========== */
  
  /* README content container */
  #readmePreview [class*="max-h-"] {
    scroll-behavior: smooth;
  }
  
  #readmePreview [class*="max-h-"]::-webkit-scrollbar {
    width: 8px;
  }
  
  #readmePreview [class*="max-h-"]::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  #readmePreview [class*="max-h-"]::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  #readmePreview [class*="max-h-"]::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
  }
  
  /* README content styling */
  .readme-content {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    line-height: 1.6;
    color: #374151;
  }
  
  .readme-content h1, 
  .readme-content h2, 
  .readme-content h3 {
    color: #111827;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    font-weight: 600;
  }
  
  .readme-content h1 {
    font-size: 1.5em;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 0.3em;
  }
  
  .readme-content h2 {
    font-size: 1.25em;
  }
  
  .readme-content h3 {
    font-size: 1.1em;
  }
  
  .readme-content h4 {
    font-size: 1em;
    font-weight: 600;
    color: #4b5563;
    margin-top: 1.2em;
    margin-bottom: 0.4em;
  }
  
  .readme-content p {
    margin-bottom: 1em;
  }
  
  .readme-content ul, 
  .readme-content ol {
    margin-left: 1.5em;
    margin-bottom: 1em;
  }
  
  .readme-content li {
    margin-bottom: 0.5em;
  }
  
  .readme-content li > ul,
  .readme-content li > ol {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
  
  .readme-content code {
    background-color: #f3f4f6;
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.9em;
    color: #dc2626;
  }
  
  .readme-content pre {
    background-color: #1f2937;
    color: #f3f4f6;
    padding: 1em;
    border-radius: 6px;
    overflow-x: auto;
    margin-bottom: 1em;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.9em;
    line-height: 1.5;
  }
  
  .readme-content pre code {
    background-color: transparent;
    padding: 0;
    color: inherit;
    font-size: inherit;
  }
  
  .readme-content a {
    color: #2563eb;
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 2px;
  }
  
  .readme-content a:hover {
    color: #1d4ed8;
    text-decoration-thickness: 2px;
  }
  
  .readme-content blockquote {
    border-left: 4px solid #e5e7eb;
    padding-left: 1em;
    margin-left: 0;
    margin-right: 0;
    color: #6b7280;
    font-style: italic;
  }
  
  .readme-content blockquote p {
    margin-bottom: 0.5em;
  }
  
  .readme-content hr {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 2em 0;
  }
  
  .readme-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1em;
  }
  
  .readme-content table th,
  .readme-content table td {
    border: 1px solid #e5e7eb;
    padding: 0.5em 0.75em;
    text-align: left;
  }
  
  .readme-content table th {
    background-color: #f9fafb;
    font-weight: 600;
  }
  
  .readme-content table tr:nth-child(even) {
    background-color: #f9fafb;
  }
  
  /* README header button styling */
  #readmePreview button[onclick="copyReadme()"] {
    transition: all 0.2s ease;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
  }
  
  #readmePreview button[onclick="copyReadme()"]:hover {
    background-color: #f3f4f6;
  }
  
  #readmePreview button[onclick="copyReadme()"].text-green-600 {
    background-color: #d1fae5;
  }
  
  /* Empty state styling */
  #readmePreview .bg-gray-50 {
    transition: all 0.3s ease;
  }
  
  #readmePreview .bg-gray-50:hover {
    background-color: #f3f4f6;
  }
  
  /* Mobile responsiveness */
  @media (max-width: 640px) {
    .preview-tab {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
    }
    
    .preview-tab i {
      margin-right: 0.375rem;
    }
    
    #imageViewer {
      min-height: 200px;
    }
    
    .thumbnail-gallery {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .thumbnail-gallery img {
      height: 5rem;
    }
    
    .readme-content {
      font-size: 0.875rem;
      line-height: 1.5;
    }
    
    .readme-content h1 {
      font-size: 1.25em;
    }
    
    .readme-content h2 {
      font-size: 1.125em;
    }
    
    .readme-content h3 {
      font-size: 1em;
    }
    
    #readmePreview .p-4 {
      padding: 1rem;
    }
  }
  
  /* Hide scrollbar but keep functionality */
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
</style>
{% if dataset.preview_file %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
{% endif %}
{% endblock %} 

{% block content %}
<!-- Desktop Sticky Header -->
<div class="hidden md:block sticky-dataset-header">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
    <div class="flex items-center justify-between">
      <!-- Breadcrumb -->
      <nav class="flex items-center text-sm text-gray-600">
        <a href="{% url 'dataset_list' %}" class="hover:text-primary">Datasets</a>
        <svg class="w-4 h-4 mx-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-primary font-medium truncate max-w-md">{{ dataset.title|truncatechars:40 }}</span>
      </nav>
      
      <!-- Authentication Circle -->
      <div class="flex items-center space-x-4 ml-4">
        {% if user.is_authenticated %}
          <div class="relative" x-data="{ profileOpen: false }">
            <button 
              type="button"
              class="focus:outline-none"
              @click="profileOpen = !profileOpen"
              @mouseenter="profileOpen = true"
              @mouseleave="setTimeout(() => { if (!profileOpen) profileOpen = false }, 100)"
            >
              {% if user.profile.avatar %}
                <img
                  src="{{ user.profile.avatar.url }}"
                  class="auth-circle h-10 w-10 cursor-pointer border-2 border-transparent hover:border-primary rounded-full"
                  alt="Profile"
                />
              {% else %}
                <div class="user-icon h-10 w-10 cursor-pointer hover:opacity-90 text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-full h-full">
                    <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd" />
                  </svg>
                </div>
              {% endif %}
            </button>
            
            <!-- Profile Dropdown -->
            <div
              x-show="profileOpen"
              x-cloak
              x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform scale-95"
              x-transition:enter-end="opacity-100 transform scale-100"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform scale-100"
              x-transition:leave-end="opacity-0 transform scale-95"
              class="absolute right-0 mt-2 min-w-[220px] bg-white shadow-xl rounded-lg py-3 z-50 border border-gray-200"
              style="display: none;"
              @mouseenter="profileOpen = true"
              @mouseleave="profileOpen = false"
              @click.away="profileOpen = false"
            >
              <a href="{% url 'profile' %}" class="block px-5 py-3 text-gray-800 hover:bg-gray-50 transition-colors border-b border-gray-100">
                <div class="flex items-center">
                  <svg class="w-5 h-5 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  <span class="font-small">My Profile</span>
                </div>
              </a>
              
              <a href="{% url 'account_change_password' %}" class="block px-5 py-3 text-gray-800 hover:bg-gray-50 transition-colors border-b border-gray-100">
                <div class="flex items-center">
                  <svg class="w-5 h-5 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                  </svg>
                  <span class="font-small">Change Password</span>
                </div>
              </a>
              
              <form action="{% url 'account_logout' %}" method="POST" class="block">
                {% csrf_token %}
                <button type="submit" class="w-full text-left px-5 py-3 text-gray-800 hover:bg-gray-50 transition-colors">
                  <div class="flex items-center">
                    <svg class="w-5 h-5 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="font-small">Logout</span>
                  </div>
                </button>
              </form>
            </div>
          </div>
        {% else %}
          <div class="flex items-center space-x-3">
            <a href="{% url 'login' %}" class="text-dark hover:text-accent font-medium transition-colors">Sign In</a>
            <a href="{% url 'signup' %}" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-red-600 font-medium transition-colors">Register</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-4 md:py-6 mt-16 sm:mt-0 mobile-content-padding">

  <!-- Dataset Title and Info -->
  <div class="flex flex-col mb-6 md:mb-8">
    <div class="flex-1 mb-4">
      <h1 class="text-xl md:text-3xl font-bold text-primary mb-2 break-words">{{ dataset.title }}</h1>
      <div class="flex flex-wrap items-center gap-2 md:gap-4 text-xs md:text-sm text-gray-600">
        <span class="flex items-center bg-gray-50 px-2 py-1 rounded">
          <svg class="w-3 h-3 md:w-4 md:h-4 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span class="truncate max-w-[80px] md:max-w-none">{{ dataset.uploaded_by.username|truncatechars:15 }}</span>
        </span>
        <span class="flex items-center bg-gray-50 px-2 py-1 rounded">
          <svg class="w-3 h-3 md:w-4 md:h-4 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {{ dataset.update_date|timesince }} ago
        </span>
        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">
          {{ dataset.format|default:"N/A" }}
        </span>
      </div>
    </div>
  </div>

  <div class="grid md:grid-cols-3 gap-4 md:gap-8">
    <!-- Dataset Info Sidebar -->
    <div class="md:col-span-1 desktop-sticky-sidebar space-y-4 md:space-y-6">
      <!-- Dataset Information Card -->
      <div class="bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h3 class="text-base md:text-lg font-semibold text-primary mb-3 md:mb-4">ðŸ“‹ Dataset Information</h3>
        <div class="space-y-2 md:space-y-3">
          {% if dataset.modality %}
          <div>
            <div class="text-xs md:text-sm text-gray-600">Modality</div>
            <div class="font-medium text-sm md:text-base">{{ dataset.get_modality_display }}</div>
          </div>
          {% endif %}
          
          {% if dataset.body_part %}
          <div>
            <div class="text-xs md:text-sm text-gray-600">Body Part</div>
            <div class="font-medium text-sm md:text-base">{{ dataset.body_part }}</div>
          </div>
          {% endif %}
          
          {% if dataset.format %}
          <div>
            <div class="text-xs md:text-sm text-gray-600">Format</div>
            <div class="font-medium text-sm md:text-base">{{ dataset.format }}</div>
          </div>
          {% endif %}
          
          {% if dataset.no_of_subjects %}
          <div>
            <div class="text-xs md:text-sm text-gray-600">Number of Subjects</div>
            <div class="font-medium text-sm md:text-base">{{ dataset.no_of_subjects }}</div>
          </div>
          {% endif %}
          
          <div>
            <div class="text-xs md:text-sm text-gray-600">Upload Date</div>
            <div class="font-medium text-sm md:text-base">{{ dataset.upload_date|date:"M d, Y" }}</div>
          </div>
          
          <div>
            <div class="text-xs md:text-sm text-gray-600">Last Updated</div>
            <div class="font-medium text-sm md:text-base">{{ dataset.update_date|date:"M d, Y" }}</div>
          </div>
        </div>
      </div>

      <!-- File Details Card - FIXED: Now using total_size_display from context -->
      <div class="bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h3 class="text-base md:text-lg font-semibold text-primary mb-3 md:mb-4 flex items-center">
          <i data-lucide="folder" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i>
          File Details
        </h3>
        <div class="space-y-2 md:space-y-3">
          <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center min-w-0">
              <i data-lucide="file" class="w-4 h-4 md:w-5 md:h-5 text-gray-400 mr-2 md:mr-3 flex-shrink-0"></i>
              <div class="min-w-0">
                <div class="font-medium text-sm md:text-base truncate">{{ dataset.title }}</div>
                <div class="text-xs md:text-sm text-gray-600 truncate">
                  {% if dataset.format %}{{ dataset.format }} â€¢ {% endif %}
                  <!-- FIXED: Using total_size_display from view context -->
                  <span class="font-semibold">{{ total_size_display|default:"Size N/A" }}</span>
                </div>
                {% if files %}
                <div class="text-xs text-gray-500 mt-1">
                  {{ total_files }} file{{ total_files|pluralize }}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- File list for multi-part datasets -->
          {% if files %}
          <div class="mt-3 border-t pt-3">
            <h4 class="text-xs font-medium text-gray-500 mb-2">Dataset Files:</h4>
            <ul class="space-y-1">
              {% for file in files %}
              <li class="text-xs flex items-center justify-between">
                <span class="truncate max-w-[150px]">{{ file.filename }}</span>
                <span class="text-gray-500">{{ file.size_display }}</span>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% elif legacy_single_file %}
          <div class="mt-3 border-t pt-3">
            <h4 class="text-xs font-medium text-gray-500 mb-2">Dataset File:</h4>
            <p class="text-xs truncate">{{ legacy_filename }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Actions Card -->
      <div class="bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h3 class="text-base md:text-lg font-semibold text-primary mb-3 md:mb-4">âš¡ Actions</h3>
        <div class="space-y-2 md:space-y-3">
          {% if user.is_authenticated %}
            {% if data_request %}
              {% if data_request.status == 'approved' and data_request.can_download %}
                <a href="{% url 'request_status' data_request.id %}" 
                  class="bg-green-600 text-white px-8 py-4 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center gap-3 mx-auto text-lg">
                  <i data-lucide="download" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i>
                  Download Dataset
                </a>
              {% elif data_request.status == 'approved' and not data_request.can_download %}
                <a href="{% url 'dataset_request' dataset.id %}" 
                  class="bg-accent text-white px-8 py-4 rounded-lg hover:bg-accent/90 transition-colors font-medium flex items-center justify-center gap-3 mx-auto text-lg">
                  <i data-lucide="file-text" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i>
                  Request Access
                </a>
                <p class="text-sm text-yellow-600 text-center mt-2">
                  Your download limit has been reached. You can request access again.
                </p>
              {% elif data_request.status == 'rejected' %}
                <a href="{% url 'dataset_request' dataset.id %}" 
                  class="bg-accent text-white px-8 py-4 rounded-lg hover:bg-accent/90 transition-colors font-medium flex items-center justify-center gap-3 mx-auto text-lg">
                  <i data-lucide="file-text" class="w-6 h-6"></i>
                  Request Access
                </a>
                <p class="text-sm text-red-600 text-center mt-2">
                  Your previous request was rejected. You can submit a new request.
                </p>
              {% else %}
                <a href="{% url 'request_status' data_request.id %}" 
                  class="bg-blue-600 text-white px-8 py-4 rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center justify-center gap-3 mx-auto text-lg">
                  <i data-lucide="clock" class="w-6 h-6"></i>
                  View Request Status
                </a>
                <p class="text-sm text-blue-600 text-center mt-2">
                  Your request is {{ data_request.get_status_display }}
                </p>
              {% endif %}
            {% else %}
              <a href="{% url 'dataset_request' dataset.id %}" 
                class="bg-accent text-white px-8 py-4 rounded-lg hover:bg-accent/90 transition-colors font-medium flex items-center justify-center gap-3 mx-auto text-lg">
                <i data-lucide="file-text" class="w-6 h-6"></i>
                Request Access
              </a>
            {% endif %}
          {% else %}
            <a href="{% url 'login' %}?next={% url 'dataset_detail' dataset.id %}" 
              class="bg-accent text-white px-8 py-4 rounded-lg hover:bg-accent/90 transition-colors font-medium flex items-center justify-center gap-3 mx-auto text-md">
              <i data-lucide="log-in" class="w-6 h-6"></i>
              Login to Request Access
            </a>
          {% endif %}
          
          <button 
            onclick="openCollectionModal()"
            class="w-full px-3 py-2 md:px-4 md:py-2 border border-primary text-primary rounded-lg hover:bg-blue-50 flex items-center justify-center gap-2 text-sm md:text-base"
          >
            <i data-lucide="bookmark" class="w-4 h-4"></i>
            {% if in_collections %}In Collection{% else %}Save{% endif %}
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="md:col-span-2 overflow-hidden">
      <!-- Preview Section -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-4 md:mb-6">
        <!-- Preview Tabs -->
        <div class="flex border-b overflow-x-auto no-scrollbar">
          <button
            id="imageTab"
            class="preview-tab flex items-center px-3 py-2 md:px-4 md:py-3 border-b-2 border-primary text-primary font-medium whitespace-nowrap flex-shrink-0 hover:bg-gray-50 transition-colors"
          >
            <i data-lucide="image" class="w-4 h-4 mr-1.5 md:mr-2 flex-shrink-0"></i>
            <span class="hidden sm:inline">Images</span>
            <span class="sm:hidden">Img</span>
          </button>
          <button
            id="csvTab"
            class="preview-tab flex items-center px-3 py-2 md:px-4 md:py-3 text-gray-600 font-medium whitespace-nowrap flex-shrink-0 hover:bg-gray-50 hover:text-primary transition-colors"
          >
            <i data-lucide="file-text" class="w-4 h-4 mr-1.5 md:mr-2 flex-shrink-0"></i>
            <span class="hidden sm:inline">Metadata</span>
            <span class="sm:hidden">Data</span>
          </button>
          <button
            id="readmeTab"
            class="preview-tab flex items-center px-3 py-2 md:px-4 md:py-3 text-gray-600 font-medium whitespace-nowrap flex-shrink-0 hover:bg-gray-50 hover:text-primary transition-colors"
          >
            <i data-lucide="book-open" class="w-4 h-4 mr-1.5 md:mr-2 flex-shrink-0"></i>
            <span class="hidden sm:inline">README</span>
            <span class="sm:hidden">Docs</span>
          </button>
        </div>

        <!-- Main Image Preview -->
        <div id="imagePreview" class="p-3 md:p-4">
          <div
            id="imageViewer"
            class="bg-gray-100 rounded-lg aspect-video flex items-center justify-center overflow-hidden"
          >
            {% if primary_thumbnail %}
              <img 
                src="{{ primary_thumbnail.image.url }}" 
                id="mainPreview"
                class="w-full h-full object-contain lazy-load"
                alt="{{ dataset.title }} preview"
                loading="lazy"
                onload="this.classList.add('lazy-loaded')"
              />
            {% else %}
              <div class="text-gray-500 p-4">
                <i data-lucide="image-off" class="w-8 h-8 md:w-12 md:h-12 mx-auto mb-2"></i>
                <p class="text-sm">No preview available</p>
              </div>
            {% endif %}
          </div>

          <!-- Thumbnail Gallery -->
          {% if thumbnails|length > 0 %}
          <div class="mt-4 md:mt-6">
            <h3 class="text-sm md:text-base font-semibold text-gray-700 mb-2 md:mb-3">Additional Views</h3>
            <div class="thumbnail-gallery grid grid-cols-3 md:grid-cols-5 gap-2 md:gap-3">
              {% for thumb in thumbnails %}
              <img 
                src="{{ thumb.image.url }}" 
                class="w-full h-20 md:h-24 object-cover rounded-lg border-2 cursor-pointer lazy-load
                       {% if thumb.id == primary_thumbnail.id %}border-primary thumbnail-active{% else %}border-gray-200 hover:border-gray-300{% endif %}"
                data-thumb-id="{{ thumb.id }}"
                onclick="setMainPreview(this)"
                alt="Thumbnail {{ forloop.counter }}"
                loading="lazy"
                onload="this.classList.add('lazy-loaded')"
              />
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Data Preview Section - FIXED: Using has_preview from context -->
        <div id="dataPreview" class="p-3 md:p-4 hidden">
          {% if has_preview and preview_rows %}
            <div class="bg-white border rounded-lg overflow-hidden">
              <div class="flex items-center justify-between p-3 border-b bg-gray-50">
                <div class="flex items-center space-x-4">
                  <div class="text-sm text-gray-600">
                    <span class="font-medium">{{ preview_rows|length }}</span> rows Ã— 
                    <span class="font-medium">{{ preview_columns|length }}</span> columns
                  </div>
                  <div class="text-xs text-gray-500 hidden md:block">
                    Scroll horizontally and vertically to view all data
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <button onclick="scrollToTop()" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded">
                    <i data-lucide="arrow-up" class="w-4 h-4"></i>
                  </button>
                  <button onclick="scrollToBottom()" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded">
                    <i data-lucide="arrow-down" class="w-4 h-4"></i>
                  </button>
                </div>
              </div>
              
              <div class="relative overflow-auto max-h-[400px] md:max-h-[500px]" id="tableContainer">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky left-0 z-20 min-w-[40px] md:min-w-[60px] border-r">
                        #
                      </th>
                      {% for col in preview_columns %}
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 min-w-[100px] md:min-w-[150px] whitespace-nowrap">
                        <div class="flex items-center justify-between">
                          <span title="{{ col }}" class="truncate max-w-[80px] md:max-w-[120px]">{{ col }}</span>
                        </div>
                      </th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    {% for row in preview_rows %}
                    <tr class="{% cycle 'bg-white' 'bg-gray-50' %} hover:bg-blue-50">
                      <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 font-mono bg-inherit sticky left-0 z-10 min-w-[40px] md:min-w-[60px] border-r">
                        {{ forloop.counter }}
                      </td>
                      {% for col in preview_columns %}
                      <td class="px-4 py-4 text-sm text-gray-900 min-w-[100px] md:min-w-[150px] max-w-[200px] md:max-w-[300px]">
                        <div class="group relative">
                          {% with value=row|get_item:col %}
                            {% if value == None or value == '' or value == 'nan' %}
                              <span class="text-gray-400 italic">null</span>
                            {% else %}
                              <div class="truncate">{{ value }}</div>
                              {% if value|stringformat:"s"|length > 30 %}
                                <div class="absolute left-0 top-full mt-1 w-64 md:w-96 p-2 md:p-3 bg-white border rounded-lg shadow-lg z-50 hidden group-hover:block">
                                  <div class="text-xs font-medium text-gray-900 mb-1">Full Content:</div>
                                  <div class="text-xs md:text-sm text-gray-600 whitespace-pre-wrap max-h-40 md:max-h-60 overflow-y-auto">{{ value }}</div>
                                </div>
                              {% endif %}
                            {% endif %}
                          {% endwith %}
                        </div>
                      </td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% elif preview_error %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <div class="flex items-center text-red-700">
                <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
                <div>
                  <p class="font-medium">Error loading preview</p>
                  <p class="text-sm">{{ preview_error }}</p>
                </div>
              </div>
            </div>
          {% else %}
            <div class="bg-gray-50 rounded-lg p-8 text-center">
              <i data-lucide="file-question" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
              <p class="text-gray-600 mb-2">No preview data available</p>
              {% if dataset.preview_file %}
              <p class="text-xs text-gray-500">Preview file exists but could not be displayed</p>
              {% endif %}
            </div>
          {% endif %}
        </div>

        <!-- README Preview Section -->
        <div id="readmePreview" class="p-3 md:p-4 hidden">
          {% if dataset.has_readme %}
            <div class="bg-white border rounded-lg overflow-hidden">
              <div class="flex items-center justify-between p-3 md:p-4 border-b bg-gray-50">
                <div class="flex items-center">
                  <i data-lucide="book-open" class="w-5 h-5 text-primary mr-2"></i>
                  <div>
                    <h3 class="font-medium text-primary">Dataset Documentation</h3>
                    {% if dataset.readme_file %}
                    <p class="text-xs text-gray-500">
                      {{ dataset.readme_file.name|cut:"readmes/" }}
                    </p>
                    {% endif %}
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  {% if dataset.readme_file %}
                                    <a href="{{ dataset.readme_file.url }}" 
                    download
                    class="text-sm text-gray-600 hover:text-primary flex items-center gap-1 px-3 py-1 border rounded hover:bg-gray-50">
                      <i data-lucide="download" class="w-4 h-4"></i>
                      Download
                  </a>
                  {% endif %}
                  <button onclick="copyReadme()" 
                          class="text-sm text-gray-600 hover:text-primary flex items-center gap-1 px-3 py-1 border rounded hover:bg-gray-50">
                      <i data-lucide="copy" class="w-4 h-4"></i>
                      Copy
                  </button>
                </div>
              </div>
              
              <!-- README Content -->
              <div class="p-4 md:p-6 max-h-[500px] overflow-y-auto readme-content">
                {% if dataset.readme_html %}
                  {{ dataset.readme_html|safe }}
                {% elif dataset.readme_content %}
                  <pre class="whitespace-pre-wrap font-sans">{{ dataset.readme_content }}</pre>
                {% else %}
                  <p class="text-gray-500">No README content available</p>
                {% endif %}
              </div>
              
              <!-- README Stats -->
              {% if dataset.readme_content %}
              <div class="px-4 py-3 border-t bg-gray-50 text-xs text-gray-500 flex justify-between">
                <div class="flex items-center gap-4">
                  <div>
                    <span class="font-medium">{{ dataset.readme_content|wordcount }}</span> words
                  </div>
                  <div>
                    <span class="font-medium">{{ dataset.readme_content|length }}</span> characters
                  </div>
                  {% if dataset.readme_updated %}
                  <div>
                    Updated: {{ dataset.readme_updated|date:"M d, Y" }}
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </div>
          {% else %}
            <div class="bg-gray-50 rounded-lg p-8 text-center">
              <i data-lucide="book-open" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
              <p class="text-gray-600 mb-2">No README documentation available</p>
              <p class="text-sm text-gray-500">Contact the dataset owner for documentation</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Description Card -->
      <div class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-4 md:mb-6">
        <h3 class="text-base md:text-lg font-semibold text-primary mb-3 md:mb-4 flex items-center">
          <i data-lucide="file-text" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i>
          Description
        </h3>
        <div class="text-sm md:text-base text-gray-700 prose prose-sm max-w-none">
          {{ dataset.description|linebreaks }}
        </div>
      </div>
    </div>
  </div>

  <!-- Similar Datasets -->
  {% if similar_datasets %}
  <div class="mt-8 md:mt-12">
    <h2 class="text-xl md:text-2xl font-semibold text-primary mb-4 md:mb-6">
      ðŸ§  Similar Datasets
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
      {% for similar in similar_datasets %}
        <a href="{% url 'dataset_detail' similar.id %}" class="block">
          <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-3 md:p-4 h-full">
            <div class="aspect-video bg-gray-100 rounded-lg mb-3 md:mb-4 overflow-hidden">
              {% if similar.primary_thumbnail %}
                <img
                  src="{{ similar.primary_thumbnail.image.url }}"
                  class="w-full h-full object-cover lazy-load"
                  alt="{{ similar.title }} thumbnail"
                  loading="lazy"
                  onload="this.classList.add('lazy-loaded')"
                />
              {% else %}
                <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                  <i data-lucide="image-off" class="w-6 h-6 md:w-8 md:h-8 text-gray-400"></i>
                </div>
              {% endif %}
            </div>
            <h3 class="font-semibold text-primary text-sm mb-2 truncate">{{ similar.title|truncatechars:50 }}</h3>
            <div class="flex items-center justify-between text-xs text-gray-600">
              <span class="truncate">{{ similar.format|default:"N/A" }}</span>
              <span class="truncate ml-2">{{ similar.get_file_size_display }}</span>
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</main>

<!-- Modals -->
<!-- Rating Modal -->
<div id="ratingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-semibold text-primary">Rate this Dataset</h3>
        <button onclick="closeRatingModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <form method="POST" action="{% url 'rate_dataset' dataset.id %}">
        {% csrf_token %}
        
        <div class="mb-4">
          <div class="flex justify-center mb-2">
            <div class="text-4xl font-bold text-primary" id="ratingValue">
              {% if user_rating %}{{ user_rating }}{% else %}0.0{% endif %}
            </div>
            <div class="ml-2 text-gray-500 text-lg mt-2">/10</div>
          </div>
          
          <input 
            type="range" 
            name="rating" 
            min="0" 
            max="10" 
            step="0.5"
            value="{% if user_rating %}{{ user_rating }}{% else %}0{% endif %}"
            class="w-full"
            id="ratingSlider"
            oninput="updateRatingDisplay(this.value)"
          >
          
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>0</span>
            <span>5</span>
            <span>10</span>
          </div>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Your Comments (Optional)</label>
          <textarea 
            name="comment" 
            rows="3"
            class="w-full border rounded p-2"
            placeholder="Share your thoughts about this dataset..."
          >{% if user_rating_obj %}{{ user_rating_obj.comment }}{% endif %}</textarea>
        </div>
        
        <div class="flex space-x-2">
          <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark">
            Submit Rating
          </button>
          <button type="button" onclick="closeRatingModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Collection Modal -->
<div id="collectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-semibold text-primary">Save to Collection</h3>
        <button onclick="closeCollectionModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      {% if user.is_authenticated %}
        <!-- Existing Collections -->
        {% if user_collections %}
        <div class="mb-6">
          <h4 class="font-medium text-sm text-gray-700 mb-3">Your Collections</h4>
          <div class="space-y-2">
            {% for collection in user_collections %}
            <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
              <div>
                <div class="font-medium">{{ collection.name }}</div>
                <div class="text-sm text-gray-500">
                  {{ collection.datasets.count }} dataset{{ collection.datasets.count|pluralize }}
                  {% if collection.description %}â€¢ {{ collection.description }}{% endif %}
                </div>
              </div>
              <button 
                type="button"
                onclick="toggleCollection({{ collection.id }}, this)"
                class="{% if collection in in_collections %}text-primary{% else %}text-gray-400 hover:text-primary{% endif %}"
                data-collection-id="{{ collection.id }}"
              >
                <i data-lucide="{% if collection in in_collections %}bookmark-minus{% else %}bookmark-plus{% endif %}" class="w-5 h-5"></i>
              </button>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <!-- Create New Collection -->
        <div>
          <h4 class="font-medium text-sm text-gray-700 mb-3">Create New Collection</h4>
          <form method="POST" action="{% url 'save_to_collection' dataset.id %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">
            <div class="space-y-3">
              <input 
                type="text" 
                name="name" 
                class="w-full border rounded p-2"
                placeholder="Collection name"
                required
              >
              <textarea 
                name="description" 
                rows="2"
                class="w-full border rounded p-2"
                placeholder="Description (optional)"
              ></textarea>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="is_public" class="rounded">
                <span class="text-sm">Make this collection public</span>
              </label>
              <div class="flex space-x-2">
                <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark">
                  Create & Add
                </button>
                <button type="button" onclick="closeCollectionModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300">
                  Cancel
                </button>
              </div>
            </div>
          </form>
        </div>
      {% else %}
        <div class="text-center py-8">
          <i data-lucide="log-in" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
          <p class="text-gray-600 mb-4">Please sign in to save datasets to collections.</p>
          <a href="{% url 'login' %}?next={{ request.path }}" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-dark inline-block">
            Sign In
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-semibold text-primary">Report an Issue</h3>
        <button onclick="closeReportModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      {% if user.is_authenticated %}
      <form method="POST" action="{% url 'report_dataset' dataset.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Issue Type</label>
            <select name="report_type" class="w-full border rounded p-2" required>
              <option value="">Select an issue type</option>
              <option value="inaccurate">Inaccurate Information</option>
              <option value="corrupt">Corrupt File</option>
              <option value="copyright">Copyright Issue</option>
              <option value="privacy">Privacy Concern</option>
              <option value="offensive">Offensive Content</option>
              <option value="other">Other Issue</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
            <textarea 
              name="description" 
              rows="4"
              class="w-full border rounded p-2"
              placeholder="Please describe the issue in detail..."
              required
            ></textarea>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Screenshot (Optional)</label>
            <input 
              type="file" 
              name="screenshot" 
              accept="image/*"
              class="w-full border rounded p-2"
            >
            <p class="text-xs text-gray-500 mt-1">Upload a screenshot if it helps explain the issue</p>
          </div>
          
          <div class="pt-4 border-t">
            <div class="flex space-x-2">
              <button type="submit" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">
                Submit Report
              </button>
              <button type="button" onclick="closeReportModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-3">
              <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
              Reports are reviewed by our team within 24-48 hours.
            </p>
          </div>
        </div>
      </form>
      {% else %}
        <div class="text-center py-8">
          <i data-lucide="log-in" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
          <p class="text-gray-600 mb-4">Please sign in to report issues.</p>
          <a href="{% url 'login' %}?next={{ request.path }}" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-dark inline-block">
            Sign In
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Custom template filter for dictionary access -->
{% load dict_extras %}
{% endblock %}

{% block extra_scripts %}
<script>
  // Initialize Lucide icons
  lucide.createIcons();

  document.addEventListener('DOMContentLoaded', function() {
    // Setup tab switching
    setupTabs();
    
    // Setup modal functions
    setupModals();
    
    // Handle mobile layout
    handleMobileLayout();
    
    // Setup mobile sidebar toggle
    setupMobileSidebar();
    
    // Handle initial tab based on URL hash
    handleInitialTab();
  });
  
  function setupTabs() {
    const imageTab = document.getElementById("imageTab");
    const csvTab = document.getElementById("csvTab");
    const readmeTab = document.getElementById("readmeTab");
    const imagePreview = document.getElementById("imagePreview");
    const dataPreview = document.getElementById("dataPreview");
    const readmePreview = document.getElementById("readmePreview");

    function resetTabs() {
      [imageTab, csvTab, readmeTab].forEach(tab => {
        if (tab) {
          tab.classList.remove("border-primary", "text-primary", "border-b-2");
          tab.classList.add("text-gray-600");
        }
      });
      
      [imagePreview, dataPreview, readmePreview].forEach(preview => {
        if (preview) {
          preview.classList.add("hidden");
        }
      });
    }

    function activateTab(tab, preview) {
      resetTabs();
      if (tab && preview) {
        tab.classList.add("border-primary", "text-primary", "border-b-2");
        tab.classList.remove("text-gray-600");
        preview.classList.remove("hidden");
        
        if (tab.id === 'imageTab') {
          history.replaceState(null, null, window.location.pathname);
        } else if (tab.id === 'csvTab') {
          history.replaceState(null, null, window.location.pathname + '#data');
        } else if (tab.id === 'readmeTab') {
          history.replaceState(null, null, window.location.pathname + '#readme');
        }
      }
    }

    if (imageTab) {
      imageTab.addEventListener("click", () => activateTab(imageTab, imagePreview));
    }

    if (csvTab) {
      csvTab.addEventListener("click", () => activateTab(csvTab, dataPreview));
    }

    if (readmeTab) {
      readmeTab.addEventListener("click", () => activateTab(readmeTab, readmePreview));
    }
  }
  
  function handleInitialTab() {
    const hash = window.location.hash;
    
    if (hash === '#readme') {
      const readmeTab = document.getElementById("readmeTab");
      if (readmeTab) readmeTab.click();
    } else if (hash === '#data') {
      const csvTab = document.getElementById("csvTab");
      if (csvTab) csvTab.click();
    }
  }
  
  window.copyReadme = function() {
    const readmeContent = document.querySelector('.readme-content');
    if (readmeContent) {
      const readmeText = readmeContent.innerText;
      navigator.clipboard.writeText(readmeText).then(() => {
        const button = document.querySelector('[onclick="copyReadme()"]');
        if (button) {
          const originalHTML = button.innerHTML;
          button.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i>Copied!';
          button.classList.add('text-green-600');
          
          setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('text-green-600');
            lucide.createIcons();
          }, 2000);
        }
      });
    }
  };
  
  function setMainPreview(element) {
    const mainPreview = document.getElementById("mainPreview");
    if (mainPreview) {
      mainPreview.src = element.src;
      mainPreview.classList.remove('lazy-loaded');
      mainPreview.onload = function() {
        this.classList.add('lazy-loaded');
      };
      
      document.querySelectorAll('.thumbnail-gallery img').forEach(thumb => {
        thumb.classList.remove('border-primary', 'thumbnail-active');
        thumb.classList.add('border-gray-200');
      });
      element.classList.add('border-primary', 'thumbnail-active');
      element.classList.remove('border-gray-200');
    }
  }
  
  function setupModals() {
    window.openRatingModal = function() {
      {% if user.is_authenticated %}
        document.getElementById('ratingModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      {% else %}
        window.location.href = "{% url 'login' %}?next={{ request.path }}";
      {% endif %}
    };
    
    window.closeRatingModal = function() {
      document.getElementById('ratingModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    };
    
    window.openCollectionModal = function() {
      {% if user.is_authenticated %}
        document.getElementById('collectionModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      {% else %}
        window.location.href = "{% url 'login' %}?next={{ request.path }}";
      {% endif %}
    };
    
    window.closeCollectionModal = function() {
      document.getElementById('collectionModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    };
    
    window.openReportModal = function() {
      {% if user.is_authenticated %}
        document.getElementById('reportModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      {% else %}
        window.location.href = "{% url 'login' %}?next={{ request.path }}";
      {% endif %}
    };
    
    window.closeReportModal = function() {
      document.getElementById('reportModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    };
    
    window.updateRatingDisplay = function(value) {
      document.getElementById('ratingValue').textContent = value;
    };
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeRatingModal();
        closeCollectionModal();
        closeReportModal();
      }
    });
    
    document.querySelectorAll('#ratingModal, #collectionModal, #reportModal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          if (this.id === 'ratingModal') closeRatingModal();
          if (this.id === 'collectionModal') closeCollectionModal();
          if (this.id === 'reportModal') closeReportModal();
        }
      });
    });
  }
  
  function handleMobileLayout() {
    const isMobile = window.innerWidth < 768;
    
    if (isMobile) {
      document.body.style.overflowX = 'hidden';
      
      const mobileHeader = document.querySelector('.mobile-sticky-header');
      if (mobileHeader) {
        mobileHeader.style.zIndex = '1001';
      }
    }
  }
  
  function setupMobileSidebar() {
    document.addEventListener('toggle-mobile-sidebar', function() {});
  }
  
  window.scrollToTop = function() {
    const container = document.getElementById('tableContainer');
    if (container) container.scrollTop = 0;
  };
  
  window.scrollToBottom = function() {
    const container = document.getElementById('tableContainer');
    if (container) container.scrollTop = container.scrollHeight;
  };
  
  window.addEventListener('resize', handleMobileLayout);
  window.addEventListener('popstate', handleInitialTab);
</script>
{% endblock %}